<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClarityPlan - Plan Projection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .dial-container {
            position: relative;
            width: 200px;
            height: 100px;
            overflow: hidden;
        }
        .dial-bg {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(from -90deg at 50% 100%, #ef4444, #f97316, #eab308, #84cc16, #22c55e);
        }
        .dial-mask {
            position: absolute;
            width: 170px;
            height: 170px;
            background: #fff;
            border-radius: 50%;
            top: 15px;
            left: 15px;
        }
        .dial-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 2px;
            height: 85px;
            background: #374151;
            transform-origin: bottom;
            transition: transform 0.7s cubic-bezier(0.68, -0.6, 0.32, 1.6);
            border-radius: 2px;
        }
        .dial-text {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }
        .insight-tab-active {
            border-color: #065f46;
            background-color: #ecfdf5;
            color: #065f46;
        }
        #income-chart-tooltip {
            position: absolute;
            display: none;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            transform: translate(-50%, -110%);
            white-space: nowrap;
            z-index: 10;
        }
        .donut-chart {
            position: relative;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 20px;
            height: calc(100% - 10px);
            width: 2px;
            background-color: #e5e7eb;
        }
        .timeline-item-dot {
            position: absolute;
            left: -8px;
            top: 10px;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background-color: #fff;
            border: 3px solid #065f46;
        }
        .modal { display: none; }
        .modal-active { display: flex; }
        .mad-lib-input {
            display: inline-block;
            background-color: #ecfdf5; 
            color: #065f46; 
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
            border: 1px solid #d1fae5;
            cursor: pointer;
            min-width: 60px;
            text-align: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- App Header -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg class="h-8 w-8 text-green-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /></svg>
                <h1 class="text-xl font-bold text-gray-800">ClarityPlan</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a href="./index.html" class="text-sm font-medium text-gray-600 hover:text-green-800">Data Entry</a>
                <span class="text-sm text-gray-600">Advisor: Jane Doe</span>
                <img class="h-9 w-9 rounded-full" src="https://i.pravatar.cc/150?u=jane" alt="Advisor profile picture">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        
        <!-- Scenario Banner -->
        <div id="scenario-banner" class="hidden mb-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-r-lg" role="alert">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-bold" id="scenario-banner-title">Viewing Scenario</p>
                    <p class="text-sm" id="scenario-banner-desc">Projections and insights have been adjusted.</p>
                </div>
                <button onclick="clearScenario()" class="text-sm font-medium text-yellow-800 hover:text-yellow-600">Clear Scenario &times;</button>
            </div>
        </div>

        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Retirement Plan Projection: The Clarks</h2>
            <p class="text-gray-500 mt-1">An interactive analysis of David & Sarah's financial future.</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Interactive Levers -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md space-y-8 self-start">
                <h3 class="text-xl font-semibold text-green-800 border-b pb-3">Strategy Levers</h3>
                
                <div class="space-y-4">
                    <label for="retire-age-david" class="block text-sm font-medium text-gray-700">Retirement Age (David)</label>
                    <input type="range" id="retire-age-david" min="60" max="70" value="65" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateProjection()">
                    <div class="flex justify-between text-xs text-gray-500"><span>60</span><span class="font-bold text-green-800 text-base" id="retire-age-david-label">65</span><span>70</span></div>
                </div>

                <div class="space-y-4">
                    <label for="retire-age-sarah" class="block text-sm font-medium text-gray-700">Retirement Age (Sarah)</label>
                    <input type="range" id="retire-age-sarah" min="60" max="70" value="65" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateProjection()">
                    <div class="flex justify-between text-xs text-gray-500"><span>60</span><span class="font-bold text-green-800 text-base" id="retire-age-sarah-label">65</span><span>70</span></div>
                </div>

                <div class="space-y-4">
                    <label for="monthly-savings" class="block text-sm font-medium text-gray-700">Additional Monthly Savings</label>
                    <input type="range" id="monthly-savings" min="0" max="5000" step="250" value="1500" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateProjection()">
                    <div class="flex justify-between text-xs text-gray-500"><span>$0</span><span class="font-bold text-green-800 text-base" id="monthly-savings-label">$1,500</span><span>$5,000</span></div>
                </div>

                <div class="space-y-4">
                    <label for="retirement-spending" class="block text-sm font-medium text-gray-700">Annual Retirement Spending</label>
                    <input type="range" id="retirement-spending" min="80000" max="150000" step="5000" value="100000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateProjection()">
                    <div class="flex justify-between text-xs text-gray-500"><span>$80k</span><span class="font-bold text-green-800 text-base" id="retirement-spending-label">$100,000</span><span>$150k</span></div>
                </div>

                 <div class="space-y-4">
                    <label for="risk-tolerance" class="block text-sm font-medium text-gray-700">Investment Risk Level</label>
                    <select id="risk-tolerance" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5" oninput="updateProjection()">
                        <option>Conservative</option>
                        <option selected>Moderate</option>
                        <option>Aggressive</option>
                    </select>
                </div>
                
                <div class="pt-6 border-t space-y-3">
                     <button onclick="openQuickAddModal()" class="w-full bg-green-800 text-white font-medium py-2.5 px-4 rounded-lg hover:bg-green-900 transition flex items-center justify-center space-x-2">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        <span>+ Add to Base Plan</span>
                    </button>
                     <button onclick="openScenarioModal()" class="w-full bg-gray-100 text-gray-700 font-medium py-2.5 px-4 rounded-lg hover:bg-gray-200 transition flex items-center justify-center space-x-2">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5m-6-15l7.5 7.5-7.5 7.5" /></svg>
                        <span>Model a Life Event</span>
                    </button>
                </div>

                <div class="pt-6 border-t">
                    <h3 class="text-lg font-semibold text-green-800">Ask Clarity</h3>
                    <p class="text-sm text-gray-500 mt-1 mb-3">Ask a question to model a new scenario.</p>
                    <div class="relative">
                        <input type="text" id="clarity-question" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5 pr-10" placeholder="e.g., Buy a rental for 50k in 3 years">
                        <button onclick="askClarity()" class="absolute inset-y-0 right-0 flex items-center pr-3">
                             <svg class="h-5 w-5 text-gray-500 hover:text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visuals & Insights -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Current Snapshot Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-2">Current Snapshot</h3>
                    <p class="text-gray-600 text-sm">Your current net worth is <span class="font-bold text-2xl text-green-800">$1,620,000</span>.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 my-4">
                        <div class="bg-teal-600 h-2.5 rounded-l-full" style="width: 89%"></div>
                        <div class="bg-orange-400 h-2.5 rounded-r-full" style="width: 11%; float: right;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span><span class="font-bold text-teal-700">$1,850,000</span> in assets</span>
                        <span><span class="font-bold text-orange-600">$230,000</span> in debt</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 pt-4 border-t">
                        <div>
                            <h4 class="font-medium mb-3 text-center">Asset Breakdown</h4>
                            <div class="flex items-center">
                                <div class="w-24 h-24 donut-chart">
                                    <svg viewBox="0 0 36 36" class="w-full h-full">
                                        <circle cx="18" cy="18" r="15.915" fill="white" stroke="#319795" stroke-width="3"></circle>
                                        <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#4a5568" stroke-width="3" stroke-dasharray="43 57" stroke-dashoffset="-32"></circle>
                                        <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#81e6d9" stroke-width="3" stroke-dasharray="25 75" stroke-dashoffset="-75"></circle>
                                    </svg>
                                </div>
                                <ul class="text-xs text-gray-600 space-y-2 ml-4">
                                    <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-gray-700 mr-2"></span>Retirement (401k, IRA): $800,000</li>
                                    <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-teal-600 mr-2"></span>Real Estate: $600,000</li>
                                    <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-teal-200 mr-2"></span>Brokerage & Savings: $450,000</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                             <h4 class="font-medium mb-3 text-center">Debt Breakdown</h4>
                             <div class="flex items-center">
                                <div class="w-24 h-24 donut-chart">
                                    <svg viewBox="0 0 36 36" class="w-full h-full">
                                        <circle cx="18" cy="18" r="15.915" fill="white" stroke="#ed8936" stroke-width="3"></circle>
                                        <circle cx="18" cy="18" r="15.915" fill="transparent" stroke="#718096" stroke-width="3" stroke-dasharray="2 98" stroke-dashoffset="0"></circle>
                                    </svg>
                                </div>
                                <ul class="text-xs text-gray-600 space-y-2 ml-4">
                                    <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-orange-400 mr-2"></span>Mortgage Debt: $225,000</li>
                                    <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-gray-500 mr-2"></span>Non-Mortgage Debt: $5,000</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="font-medium mb-3">Key Financial Goals</h4>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex justify-between"><span>Retirement Lifestyle:</span> <span class="font-semibold">$100,000 / year</span></li>
                            <li class="flex justify-between"><span>Daughter's Wedding (2030):</span> <span class="font-semibold">$50,000</span></li>
                            <li class="flex justify-between"><span>Long-Term Care (Age 85+):</span> <span class="font-semibold">$9,000 / month</span></li>
                        </ul>
                    </div>
                </div>

                <!-- Projections Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-md flex flex-col items-center justify-center">
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Plan Confidence Score</h4>
                        <div class="dial-container">
                            <div class="dial-bg"></div>
                            <div class="dial-mask"></div>
                            <div id="dial-needle" class="dial-needle" style="transform: rotate(140.4deg);"></div>
                            <div class="dial-text">
                                <span id="success-prob" class="text-4xl font-bold text-gray-800">78%</span>
                            </div>
                        </div>
                    </div>
                     <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md flex flex-col justify-center">
                        <h4 class="text-sm font-medium text-gray-500 mb-3">Future Projections</h4>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center"><span>Projected Net Worth at Age 95:</span><span id="legacy-potential" class="font-bold text-green-800">$0.8M - $2.4M</span></div>
                            <div class="flex justify-between items-center"><span>Annual Income in a Bad Market:</span><span id="income-poor-scenario" class="font-bold text-orange-600">$72,000 / year</span></div>
                            <div class="flex justify-between items-center"><span>Estimated Lifetime Taxes:</span><span id="lifetime-tax" class="font-bold text-gray-700">$1.15 Million</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Portfolio Health & Recommended Age -->
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-4">Portfolio Health Check</h3>
                    <div class="flex items-center space-x-4">
                        <div id="health-status-badge" class="bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full">Concentrated</div>
                        <p id="health-summary" class="text-sm text-gray-600">The portfolio is heavily weighted towards certain assets, which may add risk.</p>
                    </div>
                    <div id="portfolio-breakdown" class="mt-4 space-y-3 text-sm">
                        <!-- Bars will be updated by JS -->
                    </div>
                    <div id="portfolio-recommendation" class="mt-4 pt-4 border-t border-gray-200">
                        <!-- AI Recommendation will be loaded here -->
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-2">Clarity's Recommendation</h3>
                    <div class="flex items-center justify-around text-center">
                        <div>
                            <p class="text-sm text-gray-600">Recommended Age (David)</p>
                            <p id="recommended-age-david" class="text-4xl font-bold text-green-800">67</p>
                        </div>
                         <div>
                            <p class="text-sm text-gray-600">Recommended Age (Sarah)</p>
                            <p id="recommended-age-sarah" class="text-4xl font-bold text-green-800">67</p>
                        </div>
                    </div>
                    <p id="recommended-age-desc" class="text-xs text-center text-gray-500 mt-3">To achieve a 90% confidence score, a slightly delayed retirement significantly boosts the plan's resilience against market downturns.</p>
                </div>

                <!-- AI Insights and Timeline -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center space-x-2 mb-4">
                        <svg class="h-6 w-6 text-green-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" /></svg>
                        <h3 class="text-xl font-semibold text-green-800">Clarity Insights (Powered by Gemini)</h3>
                    </div>
                    
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                            <button onclick="changeTab(this, 'opportunities')" class="insight-tab-active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Opportunities</button>
                            <button onclick="changeTab(this, 'risks')" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Risks</button>
                            <button onclick="changeTab(this, 'tax')" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Tax Strategies</button>
                            <button onclick="changeTab(this, 'withdrawal')" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Withdrawal Plan</button>
                        </nav>
                    </div>

                    <div id="insight-content" class="pt-5 text-gray-700 text-sm leading-6 space-y-3">
                        <!-- Content will be loaded here by JS -->
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-6">The Clarks' Retirement Strategy Timeline</h3>
                    <div id="strategy-timeline" class="relative pl-8 timeline">
                        <!-- Phases will be dynamically added here -->
                    </div>
                </div>

                <!-- Portfolio Chart Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-4">Projected Portfolio Value Over Time</h3>
                    <div class="flex">
                        <div class="flex flex-col justify-between text-xs text-gray-500 pr-4 py-2">
                            <span>$4M</span><span>$2M</span><span>$0</span>
                        </div>
                        <div class="w-full h-80 flex items-center justify-center bg-gray-50 rounded-lg relative">
                            <svg width="100%" height="100%" viewBox="0 0 400 200" class="absolute inset-0">
                                <path d="M0,195 C50,160 150,40 200,50 S350,110 400,90 L400,160 C350,210 250,230 200,210 S50,220 0,205 Z" fill="#dcfce7" opacity="0.8"></path>
                                <path d="M0,190 C50,165 150,80 200,90 S350,140 400,120 L400,170 C350,190 250,195 200,180 S50,200 0,195 Z" fill="#6ee7b7" opacity="0.6"></path>
                                <path d="M0,192 C50,170 150,120 200,130 S350,170 400,155" stroke="#065f46" stroke-width="2" fill="none" stroke-dasharray="4 4"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex justify-around text-xs text-gray-500 pl-10 mt-2">
                        <span>Age 65</span><span>Age 75</span><span>Age 85</span><span>Age 95</span>
                    </div>
                </div>

                <!-- Income Chart Section -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold mb-4">Lifetime Income Projection</h3>
                    <div class="w-full h-96 bg-gray-50 rounded-lg relative p-4 pl-12 pt-8" id="income-chart-container">
                        <svg id="income-chart-svg" width="100%" height="100%"></svg>
                        <div id="income-chart-tooltip"></div>
                    </div>
                    <div class="mt-4 flex justify-center flex-wrap text-xs text-gray-600 gap-x-4 gap-y-1">
                        <span><span class="inline-block w-3 h-3 rounded-full bg-[#8b85c2] mr-1"></span>Work</span>
                        <span><span class="inline-block w-3 h-3 rounded-full bg-[#f4a2a3] mr-1"></span>Social Security</span>
                        <span><span class="inline-block w-3 h-3 rounded-full bg-[#e37e54] mr-1"></span>Net Savings Drawdown</span>
                        <span><span class="inline-block w-3 h-3 rounded-full bg-[#228b22] mr-1"></span>Other</span>
                        <span class="flex items-center"><svg height="2" width="12" class="mr-1"><line x1="0" y1="1" x2="12" y2="1" style="stroke:#4682b4;stroke-width:2" /></svg>Expenses & Taxes</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals (structure omitted for brevity) -->
    <div id="scenario-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">...</div>
    <div id="ask-clarity-confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">...</div>
    <div id="quick-add-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50">...</div>


    <script>
        let originalProbability = 78;
        let isScenarioActive = false;
        let pendingScenario = {};
        
        const scenarioModal = document.getElementById('scenario-modal');
        const scenarioStep1 = document.getElementById('scenario-step-1');
        const jobLossForm = document.getElementById('jobLoss-form');
        const expenseForm = document.getElementById('expense-form');
        const scenarioBannerTitle = document.getElementById('scenario-banner-title');
        const scenarioBannerDesc = document.getElementById('scenario-banner-desc');
        const askClarityConfirmModal = document.getElementById('ask-clarity-confirm-modal');
        const quickAddModal = document.getElementById('quick-add-modal');
        const quickAddStep1 = document.getElementById('quick-add-step-1');
        const quickAddStep2 = document.getElementById('quick-add-step-2');
        const quickAddTitle = document.getElementById('quick-add-title');
        const quickAddForm = document.getElementById('quick-add-form');

        function openScenarioModal() { scenarioModal.classList.add('modal-active'); }
        function closeScenarioModal() {
            scenarioModal.classList.remove('modal-active');
            jobLossForm.style.display = 'none';
            expenseForm.style.display = 'none';
            scenarioStep1.style.display = 'block';
        }

        function selectScenario(scenarioName) {
            scenarioStep1.style.display = 'none';
            if (scenarioName === 'jobLoss') {
                jobLossForm.style.display = 'block';
            } else if (scenarioName === 'expense') {
                expenseForm.style.display = 'block';
            }
        }
        
        function openQuickAddModal() { quickAddModal.classList.add('modal-active'); }
        function closeQuickAddModal() {
            quickAddModal.classList.remove('modal-active');
            quickAddStep2.style.display = 'none';
            quickAddStep1.style.display = 'block';
        }
        
        const quickAddTemplates = {
            'Income': `They expect a <select class="mad-lib-input"><option>Pension</option><option>Annuity</option></select> of $<span contenteditable="true" class="mad-lib-input">500</span>/mo starting at age <span contenteditable="true" class="mad-lib-input">65</span>.`,
            'Goal': `<div class="space-y-4">
                        <button onclick="selectGoalType('general')" class="w-full text-left p-3 border rounded-lg hover:bg-gray-100">General Goal</button>
                        <button onclick="selectGoalType('rental')" class="w-full text-left p-3 border rounded-lg hover:bg-gray-100">Rental Property Purchase</button>
                    </div>`,
            'Asset': `They have a <select class="mad-lib-input"><option>HSA</option><option>Crypto</option></select> worth $<span contenteditable="true" class="mad-lib-input">50,000</span>.`,
            'Debt': `They have an <select class="mad-lib-input"><option>Auto Loan</option><option>Student Loan</option></select> with a balance of $<span contenteditable="true" class="mad-lib-input">15,000</span>.`
        };

        const rentalGoalTemplate = `
            I plan to buy a <strong class="text-green-800">Rental Property</strong> in the year <span contenteditable="true" class="mad-lib-input">2028</span> 
            with a value of $<span contenteditable="true" class="mad-lib-input">300,000</span>. 
            I will make a down payment of $<span contenteditable="true" class="mad-lib-input">60,000</span> 
            and take out a mortgage for $<span contenteditable="true" class="mad-lib-input">240,000</span>. 
            I expect to receive $<span contenteditable="true" class="mad-lib-input">2,000</span> in monthly rental income.
        `;
        const generalGoalTemplate = `They want to plan for $<span contenteditable="true" class="mad-lib-input">25,000</span> for a <span contenteditable="true" class="mad-lib-input">new car</span> in the year <span contenteditable="true" class="mad-lib-input">2027</span>.`;

        function selectQuickAddItem(itemType) {
            quickAddStep1.style.display = 'none';
            quickAddTitle.textContent = `Add New ${itemType}`;
            quickAddForm.innerHTML = quickAddTemplates[itemType];
            quickAddStep2.style.display = 'block';
        }

        function selectGoalType(goalType) {
            if(goalType === 'rental') {
                quickAddForm.innerHTML = rentalGoalTemplate;
            } else {
                quickAddForm.innerHTML = generalGoalTemplate;
            }
        }

        function confirmQuickAdd() {
            originalProbability += 1;
            updateProjection();
            closeQuickAddModal();
        }

        function runScenario(scenarioName) {
            isScenarioActive = true;
            document.getElementById('scenario-banner').style.display = 'block';
            
            let currentProb = originalProbability;
            let newProb, scenarioDetails;

            if (scenarioName === 'jobLoss') {
                newProb = currentProb - 13;
                scenarioDetails = { type: 'Job Loss', details: 'Simulating a 12-month loss of income for David.' };
                scenarioBannerTitle.textContent = `Viewing "Job Loss" Scenario`;
                scenarioBannerDesc.textContent = `Projections adjusted for a temporary loss of income.`;
            } else if (scenarioName === 'expense') {
                newProb = currentProb - 8;
                scenarioDetails = { type: 'Unexpected Expense', details: 'Simulating a one-time $50,000 expense.' };
                 scenarioBannerTitle.textContent = `Viewing "Unexpected Expense" Scenario`;
                 scenarioBannerDesc.textContent = `Projections adjusted for a large one-time expense.`;
            }
            
            updateProjection(newProb, scenarioDetails);
            closeScenarioModal();
        }

        function clearScenario() {
            isScenarioActive = false;
            document.getElementById('scenario-banner').style.display = 'none';
            updateProjection();
        }

        function updateProjection(overrideProb, scenarioContext = null) {
            let newProb;
            const retireAgeDavid = parseInt(document.getElementById('retire-age-david').value);
            const retireAgeSarah = parseInt(document.getElementById('retire-age-sarah').value);
            const monthlySavings = parseInt(document.getElementById('monthly-savings').value);
            const retirementSpending = parseInt(document.getElementById('retirement-spending').value);
            const risk = document.getElementById('risk-tolerance').value;

            document.getElementById('retire-age-david-label').textContent = retireAgeDavid;
            document.getElementById('retire-age-sarah-label').textContent = retireAgeSarah;
            document.getElementById('monthly-savings-label').textContent = `$${monthlySavings.toLocaleString()}`;
            document.getElementById('retirement-spending-label').textContent = `$${retirementSpending.toLocaleString()}`;
            
            if (overrideProb !== undefined && overrideProb !== null) {
                newProb = overrideProb;
            } else {
                if (isScenarioActive) { return; }
                let baseProb = 60;
                baseProb += ((retireAgeDavid + retireAgeSarah) / 2 - 65) * 4;
                baseProb += (monthlySavings / 500) * 2;
                baseProb -= ((retirementSpending - 100000) / 5000) * 3;
                if(risk === 'Aggressive') baseProb += 5;
                if(risk === 'Conservative') baseProb -= 8;
                newProb = Math.max(5, Math.min(99, Math.round(baseProb)));
                originalProbability = newProb;
            }

            document.getElementById('success-prob').textContent = `${newProb}%`;
            document.getElementById('dial-needle').style.transform = `rotate(${newProb * 1.8}deg)`;
            
            const legacyLower = Math.round(newProb * 30000 - 1500000);
            const legacyUpper = Math.round(newProb * 50000 - 1000000);
            document.getElementById('legacy-potential').textContent = `$${(legacyLower / 1000000).toFixed(2)}M - $${(legacyUpper / 1000000).toFixed(2)}M`;

            const poorIncome = Math.round(retirementSpending * (newProb / 100) * 0.9);
            document.getElementById('income-poor-scenario').textContent = `$${poorIncome.toLocaleString()} / year`;

            const successProbEl = document.getElementById('success-prob');
            successProbEl.style.transform = 'scale(1.2)';
            setTimeout(() => { successProbEl.style.transform = 'scale(1)'; }, 200);

            getAIInsights({ 
                probability: newProb, 
                scenario: scenarioContext,
                legacyLower: legacyLower,
                legacyUpper: legacyUpper,
                poorIncome: poorIncome,
                retirementAge: Math.min(retireAgeDavid, retireAgeSarah)
            });

            const startYear = new Date().getFullYear();
            incomeChartData = generateIncomeData(40, startYear, startYear + (Math.min(retireAgeDavid, retireAgeSarah) - 58));
            renderIncomeChart();

            const targetProb = 90;
            const probGap = targetProb - newProb;
            const yearsToDelay = Math.max(0, Math.round(probGap / 4));
            document.getElementById('recommended-age-david').textContent = retireAgeDavid + yearsToDelay;
            document.getElementById('recommended-age-sarah').textContent = retireAgeSarah + yearsToDelay;
        }
        
        let currentInsights = {};
        let incomeChartData = [];
        
        async function callGemini(prompt) {
            console.log("Simulating Gemini call for:", prompt);
            return new Promise(resolve => {
                setTimeout(() => {
                    // This function now handles multiple types of prompts
                    if (prompt.includes("portfolio is concentrated")) {
                         resolve({ recommendation: "The heavy concentration in real estate (over 30% of assets) could be a risk. Consider discussing strategies to diversify, potentially by reallocating a portion of the taxable investments into international stocks or bonds to reduce single-market exposure." });
                    } else if (prompt.includes("Return a JSON object with four keys")) {
                        resolve({
                            opportunities: "<p>With a <strong>78% confidence score</strong>, the Clarks are in a strong position. Increasing their additional monthly savings to <strong>$2,500/month</strong> could increase their confidence score to over <strong>85%</strong>.</p>",
                            risks: "<p>The primary risk is a <strong>sequence of returns risk</strong>. A significant market downturn in the first <strong>3-5 years</strong> of retirement would have the largest negative impact on the plan's long-term success.</p> <ul><li>Consider setting aside 1-2 years of cash reserves to avoid selling stocks in a down market.</li></ul>",
                            tax: "<p>The largest tax burden will come from <strong>Required Minimum Distributions (RMDs)</strong> starting at age 75. </p><ul><li>A key strategy is to perform <strong>Roth conversions</strong> during the 'bridge years' (65-70) to reduce the future size of the pre-tax 401(k) and create a source of tax-free income.</li></ul>",
                            withdrawal: "<p>The recommended withdrawal strategy is designed to minimize taxes throughout retirement.</p><ul><li><strong>Ages 65-70 (The Bridge):</strong> Fund living expenses from the <strong>taxable brokerage account</strong> first. For healthcare, use the <strong>HSA account</strong>, as these withdrawals are tax-free for qualified medical expenses. This creates a low-income window for Roth conversions.</li><li><strong>Ages 70-75:</strong> Once Social Security begins, it will cover a large portion of expenses. Supplement the rest with withdrawals from the <strong>taxable brokerage account</strong>.</li><li><strong>Ages 75+:</strong> After RMDs begin, take the required amount from the <strong>401(k)/IRA</strong>. If more funds are needed, draw from the tax-free <strong>Roth IRA</strong> last to allow it to grow for as long as possible.</li></ul>"
                        });
                    } else {
                        // Default fallback for askClarity parsing
                        resolve({ eventType: 'unknown', eventName: 'Parsed Scenario', amount: 0, year: 2025 });
                    }
                }, 800);
            });
        }
        
        async function getAIInsights(data) {
            const insightContentEl = document.getElementById('insight-content');
            insightContentEl.innerHTML = `<p class="text-gray-500">✨ Generating new insights...</p>`;
            
            let prompt = `You are a critical financial planning analyst. A client's retirement plan has a ${data.probability}% success probability. `;
            if(data.scenario) {
                prompt += `This is a "what-if" scenario modeling a ${data.scenario.type}. Specifics: ${data.scenario.details}. Generate insights on how to navigate this specific event. `
            } else {
                 prompt += `The projected legacy potential (net worth at age 95) is between $${data.legacyLower.toLocaleString()} and $${data.legacyUpper.toLocaleString()}. In a poor scenario (10th percentile), the plan can support an annual income of $${data.poorIncome.toLocaleString()}. The clients retire at age ${data.retirementAge} and Medicare begins at 65. The recommended strategy is to delay social security to age 70 and perform Roth conversions in the bridge years. `
            }
            prompt += `Generate detailed, actionable insights...`;
            
            currentInsights = await callGemini(prompt);
            changeTab(document.querySelector('.insight-tab-active'), 'opportunities');
        }
        
        function changeTab(tabElement, tabName) {
            document.querySelectorAll('.insight-tab-active').forEach(t => t.classList.remove('insight-tab-active'));
            tabElement.classList.add('insight-tab-active');
            
            const insightContentEl = document.getElementById('insight-content');
            if (currentInsights && currentInsights[tabName]) {
                 insightContentEl.innerHTML = currentInsights[tabName];
            } else {
                 insightContentEl.innerHTML = `<p>No insights available for this section yet.</p>`;
            }
        }

        function generateIncomeData(years = 40, startYear = 2025, retireYear = 2032) {
             return Array.from({ length: years }, (_, i) => {
                const currentYear = startYear + i;
                const isRetired = currentYear >= retireYear;
                return {
                    year: currentYear,
                    work: isRetired ? 0 : 350000 - i * 5000,
                    socialSecurity: isRetired ? 66000 : 0,
                    netSavingsDrawdown: isRetired ? Math.max(0, 40000 - (currentYear - retireYear) * 1500) + Math.random() * 5000 : 0,
                    other: isRetired ? Math.max(0, 20000 - (currentYear - retireYear) * 800) + Math.random() * 3000 : 0,
                    expenses: isRetired ? 150000 + (currentYear - retireYear) * 2000 : 200000 + i * 1000
                };
            });
        }

        function renderIncomeChart() {
            const container = document.getElementById('income-chart-container');
            const svg = document.getElementById('income-chart-svg');
            const tooltip = document.getElementById('income-chart-tooltip');
            if (!container || !svg || !tooltip) return;
            svg.innerHTML = '';

            const width = container.clientWidth;
            const height = container.clientHeight;
            const data = incomeChartData;
            const years = data.length;
            const maxVal = 900000;
            
            const barWidth = width / years;

            const colors = { work: '#8b85c2', socialSecurity: '#f4a2a3', netSavingsDrawdown: '#e37e54', other: '#228b22', expenses: '#4682b4' };

            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for(let i = 0; i <= 6; i++) {
                const val = i * 150000;
                const y = height - (val / maxVal * height);
                const label = val === 0 ? '$0' : `$${val/1000}k`;
                if(y >= 0) {
                    yAxis.innerHTML += `
                        <text x="-5" y="${y + 3}" font-size="10" fill="#6b7280" text-anchor="end">${label}</text>
                        <line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="#e5e7eb" stroke-dasharray="2 2"/>
                    `;
                }
            }
            svg.appendChild(yAxis);

            const retireAgeDavid = parseInt(document.getElementById('retire-age-david').value);
            const retireYearIndex = data.findIndex(d => d.work === 0);
            const medicareYearIndex = retireYearIndex + (65 - retireAgeDavid);
            if (medicareYearIndex > retireYearIndex) {
                 const bridgeRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                 bridgeRect.setAttribute('x', retireYearIndex * barWidth);
                 bridgeRect.setAttribute('y', 0);
                 bridgeRect.setAttribute('width', (medicareYearIndex - retireYearIndex) * barWidth);
                 bridgeRect.setAttribute('height', height);
                 bridgeRect.setAttribute('fill', 'rgba(70, 130, 180, 0.05)');
                 svg.appendChild(bridgeRect);
                 
                 const bridgeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                 bridgeText.setAttribute('x', (retireYearIndex + (medicareYearIndex - retireYearIndex)/2) * barWidth);
                 bridgeText.setAttribute('y', 15);
                 bridgeText.setAttribute('font-size', '10');
                 bridgeText.setAttribute('fill', '#4682b4');
                 bridgeText.setAttribute('text-anchor', 'middle');
                 bridgeText.textContent = 'Healthcare Bridge Period';
                 svg.appendChild(bridgeText);
            }

            const barsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const linePoints = [];

            data.forEach((d, i) => {
                let currentY = height;
                
                ['work', 'socialSecurity', 'netSavingsDrawdown', 'other'].forEach(key => {
                    const valHeight = (d[key] / maxVal) * height;
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', i * barWidth);
                    rect.setAttribute('y', currentY - valHeight);
                    rect.setAttribute('width', barWidth * 0.8);
                    rect.setAttribute('height', valHeight);
                    rect.setAttribute('fill', colors[key]);
                    barsGroup.appendChild(rect);
                    currentY -= valHeight;
                });

                const expenseY = height - ((d.expenses / maxVal) * height);
                linePoints.push(`${i * barWidth + (barWidth * 0.4)},${expenseY}`);
            });
            svg.appendChild(barsGroup);

            const expenseLine = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            expenseLine.setAttribute('points', linePoints.join(' '));
            expenseLine.setAttribute('fill', 'none');
            expenseLine.setAttribute('stroke', colors.expenses);
            expenseLine.setAttribute('stroke-width', '2');
            svg.appendChild(expenseLine);

            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            for(let i = 0; i < years; i += 5) {
                const x = i * barWidth + (barWidth / 2);
                xAxis.innerHTML += `<text x="${x}" y="${height + 15}" font-size="10" fill="#6b7280" text-anchor="middle">${data[i].year}</text>`;
            }
            svg.appendChild(xAxis);

            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const index = Math.floor(x / barWidth);
                if (index >= 0 && index < data.length) {
                    const d = data[index];
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${x}px`;
                    tooltip.style.top = `${y}px`;
                    let tooltipHTML = `<div class="font-bold mb-1">${d.year}</div>`;
                    if (d.work > 0) tooltipHTML += `<div><span class="inline-block w-2 h-2 rounded-full" style="background-color:${colors.work}"></span> Work: $${d.work.toLocaleString()}</div>`;
                    if (d.socialSecurity > 0) tooltipHTML += `<div><span class="inline-block w-2 h-2 rounded-full" style="background-color:${colors.socialSecurity}"></span> SS: $${d.socialSecurity.toLocaleString()}</div>`;
                    if (d.netSavingsDrawdown > 0) tooltipHTML += `<div><span class="inline-block w-2 h-2 rounded-full" style="background-color:${colors.netSavingsDrawdown}"></span> Drawdown: $${Math.round(d.netSavingsDrawdown).toLocaleString()}</div>`;
                    if (d.other > 0) tooltipHTML += `<div><span class="inline-block w-2 h-2 rounded-full" style="background-color:${colors.other}"></span> Other: $${Math.round(d.other).toLocaleString()}</div>`;
                    tooltipHTML += `<div class="border-t border-gray-400 mt-1 pt-1"><span style="color: white;">Expenses: $${d.expenses.toLocaleString()}</span></div>`;
                    tooltip.innerHTML = tooltipHTML;
                }
            });

             container.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
        
        async function askClarity() {
            const question = document.getElementById('clarity-question').value;
            if (!question) return;

            const prompt = `You are an AI that parses financial planning scenarios. Analyze the following user query...`;
            
            const parsedScenario = await callGemini(prompt);
            
            pendingScenario = parsedScenario;

            document.getElementById('ask-clarity-confirm-text').innerHTML = `Okay, I'm ready to model a new scenario: Adding a <strong>${parsedScenario.eventType}</strong> of <strong>$${parsedScenario.amount.toLocaleString()}</strong> in <strong>${parsedScenario.year}</strong> for a <strong>'${parsedScenario.eventName}'</strong>. Is that correct?`;
            askClarityConfirmModal.classList.add('modal-active');
        }
        
        function closeAskClarityModal() {
            askClarityConfirmModal.classList.remove('modal-active');
            pendingScenario = {};
        }

        function confirmScenarioUpdate() {
            let impact = 0;
            if (pendingScenario.eventType === 'oneTimeExpense') {
                impact = Math.round(pendingScenario.amount / 10000);
            }
            
            const newProb = originalProbability - impact;
            
            scenarioBannerTitle.textContent = `Viewing "${pendingScenario.eventName}" Scenario`;
            scenarioBannerDesc.textContent = `Projections adjusted for this event.`;
            document.getElementById('scenario-banner').style.display = 'block';
            isScenarioActive = true;
            
            updateProjection(newProb, { type: pendingScenario.eventName, details: `A $${pendingScenario.amount.toLocaleString()} expense in ${pendingScenario.year}.`});
            
            closeAskClarityModal();
        }
        
        function renderStrategyTimeline() {
            const timelineContainer = document.getElementById('strategy-timeline');
            if (!timelineContainer) return;

            timelineContainer.innerHTML = '';

            const phases = [
                {
                    title: 'The Bridge Years',
                    age: '(Ages 65-70)',
                    description: "During this phase, you'll delay Social Security to maximize future benefits. Living expenses will be covered by drawing from your 401(k), while simultaneously performing strategic Roth conversions in these lower-income years.",
                    icon: `<svg class="h-6 w-6 text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                },
                {
                    title: 'Maximizing Social Security',
                    age: '(Age 70 Onward)',
                    description: "At age 70, you'll turn on your maximized Social Security benefits. This provides a stable, inflation-adjusted income stream, reducing the pressure on your investment portfolio for the rest of your life.",
                    icon: `<svg class="h-6 w-6 text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0H21m-9 12h9M12 9v6m0 0H3m9 0h9" /></svg>`
                },
                {
                    title: 'Managing RMDs & Taxes',
                    age: '(Age 75 Onward)',
                    description: "When Required Minimum Distributions (RMDs) begin, your earlier Roth conversions will pay off. By drawing from tax-free Roth accounts, you can better manage your taxable income, potentially keeping more of your Social Security benefits tax-free.",
                    icon: `<svg class="h-6 w-6 text-green-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125c-.621 0-1.125-.504-1.125-1.125v-6.75zM4.125 12V8.25c0-.621.504-1.125 1.125-1.125h13.5c.621 0 1.125.504 1.125 1.125V12m-15 8.25h15M12 15v.018" /></svg>`
                }
            ];

            phases.forEach((phase, index) => {
                const isLast = index === phases.length - 1;
                const item = document.createElement('div');
                item.className = `relative ${isLast ? '' : 'pb-8'}`;
                item.innerHTML = `
                    <div class="timeline-item-dot"></div>
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-6 shrink-0">${phase.icon}</div>
                        <div>
                            <p class="font-semibold text-green-800">${phase.title} <span class="text-sm font-medium text-gray-500">${phase.age}</span></p>
                            <p class="text-sm text-gray-600 mt-1">${phase.description}</p>
                        </div>
                    </div>
                `;
                timelineContainer.appendChild(item);
            });
        }
        
        async function renderPortfolioHealth() {
            const container = document.getElementById('portfolio-breakdown');
            const badge = document.getElementById('health-status-badge');
            const summary = document.getElementById('health-summary');
            const recommendationContainer = document.getElementById('portfolio-recommendation');
            if(!container || !badge || !summary || !recommendationContainer) return;

            const assets = [
                { name: 'Retirement (401k, IRA)', value: 800000, color: 'bg-green-700' },
                { name: 'Real Estate', value: 600000, color: 'bg-teal-500' },
                { name: 'Brokerage & Savings', value: 450000, color: 'bg-green-500' },
                { name: 'Crypto', value: 50000, color: 'bg-yellow-400' },
                { name: 'Cash & HSA', value: 75000, color: 'bg-gray-400' }
            ];

            const totalAssets = assets.reduce((sum, asset) => sum + asset.value, 0);
            container.innerHTML = '';
            let isConcentrated = false;
            let portfolioString = "";

            assets.forEach(asset => {
                const percentage = (asset.value / totalAssets) * 100;
                if (percentage > 40) isConcentrated = true;
                portfolioString += `${asset.name}: ${Math.round(percentage)}%, `;
                const row = document.createElement('div');
                row.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">${asset.name}</span>
                        <span class="text-sm font-medium text-gray-700">${Math.round(percentage)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="${asset.color} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
                container.appendChild(row);
            });

            recommendationContainer.innerHTML = `<p class="text-gray-500 text-sm">✨ Generating recommendation...</p>`;

            if (isConcentrated) {
                badge.className = 'bg-yellow-100 text-yellow-800 text-sm font-medium px-3 py-1 rounded-full';
                badge.textContent = 'Concentrated';
                summary.textContent = 'The portfolio is heavily weighted towards certain assets, which may add risk.';
                
                const prompt = `A client's portfolio is concentrated. Breakdown: ${portfolioString}. Suggest one actionable talking point for the advisor to discuss diversification. Return a single short paragraph as a JSON object with a "recommendation" key.`;
                const result = await callGemini(prompt);
                recommendationContainer.innerHTML = `
                     <div class="flex items-start">
                        <div class="shrink-0">
                            <svg class="h-5 w-5 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-gray-600">${result.recommendation}</p>
                        </div>
                    </div>
                `;

            } else {
                badge.className = 'bg-green-100 text-green-800 text-sm font-medium px-3 py-1 rounded-full';
                badge.textContent = 'Balanced';
                summary.textContent = 'The current allocation appears to be well-diversified across different asset types.';
                recommendationContainer.innerHTML = '';
            }
        }

        // Initial Load
        window.onload = () => {
             const startYear = new Date().getFullYear();
             incomeChartData = generateIncomeData(40, startYear, startYear + (65-58));
             updateProjection();
             renderIncomeChart();
             renderStrategyTimeline();
             renderPortfolioHealth();
             window.addEventListener('resize', renderIncomeChart);
        };
    </script>
</body>
</html>

